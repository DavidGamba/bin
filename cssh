#!/usr/bin/expect -f

# Given a hostname it reads the file ~/.ssh/config and checks if a password is
# present.
#
# Syntax:
# Host hostname # password
#
# Usage:
# cssh <hostname>

set given_hostname [lindex $argv 0]

if { $argc < 1 } {
  puts "Missing hostname!"
  puts "  cssh <hostname>"
  exit 1
}

proc run_ask_pass_ssh {hostname} {
  spawn ssh -t $hostname "bash -o vi -i"
  interact
}

proc run_ssh {hostname password} {
  spawn ssh -t $hostname "bash -o vi -i"
  expect {
    "disconnect" {
      exit
    }
    "no)?" {
      send -- "yes\r"
      exp_continue
    }
    "assword:" {
      send -- "$password\r"
      exp_continue
    }
    "~" {
      send_user ":)"
    }
  }
  interact
}

# Slurp up the data file
set fh [open "~/.ssh/config" r ]
set file_data [read $fh]
close $fh

# Process data file
set data [split $file_data "\n"]

# Read each line of data
foreach line $data {
  # puts $line
  regexp {Host (\S*) # (\S*)} $line -> hostname password
  if [ info exists hostname ] {
    if { [string compare $given_hostname $hostname ] == 0 } {
      run_ssh $hostname $password
    }
  } else {
    regexp {Host (\S*)} $line -> hostname
    if [ info exists hostname ] {
      if { [string compare $given_hostname $hostname ] == 0 } {
        run_ask_pass_ssh $hostname
      }
    }
  }
  # clean up variables for next iteration
  if [ info exists hostname ] { unset hostname }
  if [ info exists password ] { unset password }
}

# vi:ft=tcl
